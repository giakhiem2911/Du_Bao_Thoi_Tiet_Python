<!DOCTYPE html>
<html lang="vi" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Ứng dụng Thời tiết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-weather="{{ du_bao_gio[0].mo_ta if du_bao_gio else '' }}" class="position-relative">

<div id="animated-bg"></div>
<img id="weather-animation" src="" alt="weather animation">

<div class="container py-4">
    <h1 class="text-center mb-4 text-secondary"><i class="bi bi-cloud-sun"></i> Weather App</h1>

    <!-- Nút đổi chế độ sáng/tối -->
    <button class="btn btn-outline-secondary toggle-btn" id="toggleTheme">
        <i class="bi bi-moon-stars"></i> Dark Mode
    </button>

    <form method="POST" class="row g-3 justify-content-center mt-3 position-relative">
        <div class="col-md-6 position-relative">
            <input type="text" id="cityInput" class="form-control" name="city" placeholder="Input the city name..." autocomplete="off" required value="{{ thanh_pho }}">
            <div id="suggestions" style="display:none;"></div>
        </div>
        <div class="col-md-2">
            <select name="don_vi" id="donViSelect" class="form-select">
                <option value="metric" {% if don_vi == 'metric' %}selected{% endif %}>°C</option>
                <option value="imperial" {% if don_vi == 'imperial' %}selected{% endif %}>°F</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-secondary w-100">
                <i class="bi bi-search"></i> Search
            </button>
        </div>
        <div class="text-center">
            <button type="button" class="text-secondary btn btn-outline-secondary mt-3 custom-hover" onclick="getLocation()">
                <i class="bi bi-geo-alt-fill"></i> My Location
            </button>
        </div>

        {% if du_bao_gio %}

        <div class="d-flex justify-content-center mt-4">
            <div class="ios-weather-box p-4 rounded-4 shadow-sm text-white text-center" style="max-width: 400px; width: 100%;">
                <div class="fs-4 fw-semibold text-light">{{ thanh_pho }}</div>
                <div class="fs-6 text-light mb-2">
                    {{ gio_hien_tai }} • {{ du_bao_gio[0].mo_ta|capitalize }}
                </div>
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <img src="http://openweathermap.org/img/wn/{{ du_bao_gio[0].icon }}@2x.png" alt="icon" style="width: 64px;">
                    <div class="fs-1 fw-bold ms-2 text-light">
                        {{ du_bao_gio[0].nhiet_do }}{{ "°C" if don_vi == 'metric' else "°F" }}
                    </div>
                </div>
            </div>
        </div>

        {% endif %}
    </form>

    <div id="loading-msg" class="text-center mt-3 text-muted">
        <i class="bi bi-geo-fill"></i> Getting your location...
    </div>

    {% if du_bao_ngay == None %}
        <div class="alert alert-danger mt-4"><i class="bi bi-exclamation-triangle-fill"></i> City not found. Try again!</div>
    {% endif %}

    {% if du_bao_ngay %}
    <div class="row mt-5">
        <div class="col-md-6">
            <h4 class="text-secondary mb-3"><i class="bi bi-calendar-event"></i> Next 5 days</h4>
            <div class="d-flex flex-wrap gap-3">
                {% for ngay, muc in du_bao_ngay.items() %}
                    <div class="p-3 weather-card text-center" style="width: 160px;">
                        <div class="fw-bold">{{ ngay|datetimeformat }}</div>
                        <img class="weather-icon" src="http://openweathermap.org/img/wn/{{ muc.icon }}@2x.png" alt="icon">
                        <div class="text-capitalize">{{ muc.mo_ta }}</div>
                        <div class="fw-bold">{{ muc.nhiet_do }}{{ "°C" if don_vi == 'metric' else "°F" }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-6">
            <h4 class="text-secondary mb-3"><i class="bi bi-clock-history"></i> Today</h4>
            <div class="list-group shadow-sm">
                {% for muc in du_bao_gio %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>{{ muc.gio }}</strong> - <span class="text-capitalize">{{ muc.mo_ta }}</span></span>
                        <span>
                            {{ muc.nhiet_do }}{{ "°C" if don_vi == 'metric' else "°F" }}
                            <img src="http://openweathermap.org/img/wn/{{ muc.icon }}@2x.png" alt="icon" width="40">
                        </span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const toggleBtn = document.getElementById('toggleTheme');
    const htmlTag = document.documentElement;

    toggleBtn.addEventListener('click', () => {
        const currentTheme = htmlTag.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        htmlTag.setAttribute('data-bs-theme', newTheme);
        toggleBtn.innerHTML = newTheme === 'dark' ?
            '<i class="bi bi-brightness-high"></i> Light Mode' :
            '<i class="bi bi-moon-stars"></i> Dark Mode';
    });

    const anim = document.getElementById('weather-animation');
    const weather = document.body.getAttribute('data-weather');

    if (weather) {
        const condition = weather.toLowerCase();
        let animation = '';

        if (condition.includes('rain')) {
            animation = 'rainy.gif';
        } else if (condition.includes('snow')) {
            animation = 'snowy.gif';
        } else if (condition.includes('cloud')) {
            animation = 'cloudy.gif';
        } else if (condition.includes('storm') || condition.includes('thunder')) {
            animation = 'stormy.gif';
        } else if (condition.includes('fog') || condition.includes('mist') || condition.includes('haze')) {
            animation = 'foggy.gif';
        } else if (condition.includes('clear') || condition.includes('sun')) {
            animation = 'sunny.gif';
        }

        if (animation) {
            anim.src = `/static/weather_animations/${animation}`;
        }
    }
</script>
<script>
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    fetch("/weather_by_location", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ lat, lon })
                    }).then(res => {
                        if (res.redirected) {
                            window.location.href = res.url;
                        }
                    }).catch(error => {
                        alert("Lỗi khi lấy dữ liệu thời tiết.");
                    });
                },
                () => alert("Không thể truy cập vị trí.")
            );
        } else {
            alert("Trình duyệt không hỗ trợ định vị.");
        }
    }
</script>
<script>
document.getElementById('donViSelect').addEventListener('change', function () {
    this.form.submit(); // Gửi form khi người dùng chọn đơn vị nhiệt độ khác
});
document.getElementById("loading-msg").style.display = "none";
document.addEventListener("DOMContentLoaded", function () {
    if (!window.location.search.includes("city=")) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    fetch("/weather_by_location", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        })
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi gửi tọa độ:", error);
                    });
                },
                function (error) {
                    console.warn("Không thể lấy vị trí:", error);
                }
            );
        } else {
            console.warn("Trình duyệt không hỗ trợ geolocation.");
        }
    }
});
</script>
<script>
    // Phần gợi ý tìm kiếm thành phố
    const cityInput = document.getElementById('cityInput');
    const suggestionsBox = document.getElementById('suggestions');

    cityInput.addEventListener('input', () => {
        const query = cityInput.value.trim();

        if (query.length < 2) {
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
            return;
        }

        fetch(`/suggest_city?query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                console.log(JSON.stringify(data, null, 2));
                if (data.length === 0) {
                    suggestionsBox.style.display = 'none';
                    suggestionsBox.innerHTML = '';
                    return;
                }

                suggestionsBox.innerHTML = '';
                data.forEach(city => {
                    const div = document.createElement('div');
                    div.textContent = city.description; 
                    div.addEventListener('click', () => {
                        cityInput.value = city.description;
                        suggestionsBox.style.display = 'none';
                    });
                    suggestionsBox.appendChild(div);
                });
                suggestionsBox.style.display = 'block';
            })
            .catch(() => {
                suggestionsBox.style.display = 'none';
                suggestionsBox.innerHTML = '';
            });
    });

    // Ẩn gợi ý khi click ra ngoài
    document.addEventListener('click', (e) => {
        if (!suggestionsBox.contains(e.target) && e.target !== cityInput) {
            suggestionsBox.style.display = 'none';
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
